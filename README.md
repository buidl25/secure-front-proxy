# Защищенный прокси с Basic Auth для Railway.app

Этот проект предоставляет простой способ добавить базовую HTTP-аутентификацию (Basic Auth) к любому веб-приложению, работающему на Railway.app, без необходимости изменения исходного кода самого приложения.

## Особенности

- Базовая HTTP-аутентификация для защиты доступа к вашему приложению
- Работает как с публичными URL, так и с внутренними сервисами Railway
- Расширенная диагностика и логирование для упрощения отладки
- Поддержка WebSocket для современных веб-приложений
- Страница статуса для мониторинга работоспособности

## Быстрый старт

Нажмите кнопку ниже, чтобы развернуть прокси на Railway:

[![Deploy on Railway](https://railway.app/button.svg)](https://railway.app/template/bYH8Xt?referralCode=WSv72h)

## Подробная инструкция

### Шаг 1: Подготовка

Склонируйте или форкните этот репозиторий и разверните его в том же проекте Railway, где находится сервис, который вы хотите защитить.

```bash
git clone https://github.com/buidl25/secure-front-proxy.git
cd secure-front-proxy
```

### Шаг 2: Настройка переменных окружения

При деплое на Railway настройте следующие переменные окружения:

#### Обязательные переменные

| Переменная | Описание | Пример |
|------------|----------|--------|
| `PROXY_PASS` | URL сервиса, который нужно проксировать | `https://your-app.up.railway.app` |
| `ENABLE_ALPINE_PRIVATE_NETWORKING` | Включение поддержки сети для Alpine-образов | `true` |

#### Дополнительные переменные

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| `PORT` | Порт для публичного доступа | `80` |
| `USERNAME` | Имя пользователя для аутентификации | `user` |
| `PASSWORD` | Пароль для аутентификации | `password` |

### Шаг 3: Деплой

После настройки переменных окружения выполните деплой на Railway:

```bash
git push railway main
```

Или используйте веб-интерфейс Railway для деплоя из репозитория GitHub.

## Рекомендации по использованию

### Использование с публичными URL

Для защиты публичного сервиса используйте полный URL в переменной `PROXY_PASS`:

```env
PROXY_PASS=https://your-app.up.railway.app
```

### Использование с внутренними сервисами Railway

Для работы с внутренними сервисами Railway через Private Networking:

1. Убедитесь, что установлена переменная `ENABLE_ALPINE_PRIVATE_NETWORKING=true`
2. Используйте внутренний домен в формате `http://service-name.railway.internal`

```env
PROXY_PASS=http://your-service.railway.internal
```

### Диагностика проблем

Если у вас возникают проблемы с подключением:

1. Проверьте логи контейнера в Railway для получения диагностической информации
2. Убедитесь, что переменная `ENABLE_ALPINE_PRIVATE_NETWORKING` установлена в `true`
3. Проверьте доступность страницы статуса по адресу `/nginx-status`
4. Проверьте работоспособность прокси по адресу `/health`
5. Попробуйте прямой доступ без аутентификации по адресу `/direct/`

### Решение проблемы "Service Temporarily Unavailable"

Если вы видите ошибку "Service Temporarily Unavailable" (HTTP 503), это может быть вызвано одной из следующих причин:

1. **Проблема с проксированием URL**:
   - Проверьте, что переменная `PROXY_PASS` содержит правильный URL бэкенд-сервера
   - Убедитесь, что URL содержит протокол (http:// или https://)

2. **Проблема с SSL-соединением**:
   - Если бэкенд использует самоподписанный или недействительный SSL-сертификат, установите `USE_HTTP_BACKEND=true`
   - Проверьте доступность бэкенда напрямую с помощью `curl`

3. **Проблема с DNS-резолвингом**:
   - Если вы используете внутренний домен Railway (*.railway.internal), убедитесь, что включена поддержка Private Networking
   - Попробуйте использовать публичный URL вместо внутреннего

4. **Проблема с заголовком Host**:
   - Если бэкенд требует определенный заголовок Host, установите переменную окружения `CUSTOM_HOST` с нужным значением

Пример настройки для решения проблемы:

```env
PROXY_PASS=https://delta-neutral-lp-bot-dev-production.up.railway.app
USE_HTTP_BACKEND=true
ENABLE_ALPINE_PRIVATE_NETWORKING=true
```

## Структура проекта

- `Dockerfile` - Конфигурация Docker-образа на базе Nginx Alpine
- `nginx.conf.template` - Шаблон конфигурации Nginx
- `gen_passwd.sh` - Скрипт для генерации файла с паролями
- `docker-entrypoint.sh` - Скрипт точки входа с диагностикой

## Безопасность

Обратите внимание, что Basic Auth передает учетные данные в кодировке base64, которая не является безопасным шифрованием. Для продакшн-окружений рекомендуется:

1. Использовать сложные пароли
2. Обеспечить HTTPS-соединение
3. Регулярно менять учетные данные

## Ссылки

1. [Документация по Private Networking в Railway](https://docs.railway.app/reference/private-networking)
2. [Workaround для Alpine-образов в Railway](https://docs.railway.app/reference/private-networking#workaround-for-alpine-based-images)
3. [Документация Nginx по модулю auth_basic](https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html)
